<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ğŸŒ TAAA Semanticâ€“Co-Word Analyzer</title>
<style>
body {
  font-family: 'Segoe UI', 'Noto Sans TC', sans-serif;
  background: #fafafa;
  text-align: center;
  margin: 50px;
}
.container {
  background: #fff;
  padding: 30px;
  border-radius: 14px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  display: inline-block;
  width: 580px;
}
h1 { margin-top: 0; color: #2a2a2a; }
h3 { color: #555; font-weight: 400; margin-top: -5px; }
button {
  margin-top: 15px;
  background: #0066cc;
  color: white;
  border: none;
  padding: 10px 24px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 15px;
}
button:hover { background: #004a99; }
.spinner {
  display: none;
  margin-top: 20px;
  font-style: italic;
  color: #666;
}
footer {
  margin-top: 30px;
  font-size: 13px;
  color: #888;
}
a.sample-btn {
  display: inline-block;
  margin: 6px;
  padding: 8px 16px;
  background: #f0f0f0;
  color: #333;
  border-radius: 8px;
  text-decoration: none;
  font-size: 14px;
}
a.sample-btn:hover { background: #e0e0e0; }
#previewTable {
  display: none;
  margin-top: 20px;
  border-collapse: collapse;
  width: 100%;
  font-size: 13px;
}
#previewTable th, #previewTable td {
  border: 1px solid #ddd;
  padding: 4px 6px;
}
#previewTable th {
  background: #f5f5f5;
  font-weight: bold;
}
#modeLabel {
  display: none;
  margin-top: 10px;
  font-weight: bold;
  font-size: 15px;
  transition: opacity 0.8s ease-in-out;
}
#modeHint {
  display: none;
  margin-top: 4px;
  font-size: 13px;
  color: #777;
  font-style: italic;
}

/* ğŸ’š Blink animation for Abstract mode */
.blink-green { animation: blinkGreen 1s infinite; }
@keyframes blinkGreen {
  0% { color: #2a7; text-shadow: 0 0 5px #3fa; opacity: 1; }
  50% { color: #5f5; text-shadow: 0 0 10px #7f7; opacity: 0.4; }
  100% { color: #2a7; text-shadow: 0 0 5px #3fa; opacity: 1; }
}

/* ğŸ’™ Blink animation for Co-Word mode */
.blink-blue { animation: blinkBlue 1s infinite; }
@keyframes blinkBlue {
  0% { color: #07c; text-shadow: 0 0 5px #3af; opacity: 1; }
  50% { color: #4bf; text-shadow: 0 0 10px #7df; opacity: 0.4; }
  100% { color: #07c; text-shadow: 0 0 5px #3af; opacity: 1; }
}

#resultDownloads {
  display: none;
  margin-top: 25px;
}
#resultDownloads h4 {
  color: #333;
  font-size: 14px;
}
</style>
</head>
<body>
<div class="container">
  <h1 id="title">ğŸŒ TAAA Semanticâ€“Co-Word Analyzer</h1>
  <h3 id="subtitle">Auto-detects abstract vs co-word data Â· multilingual friendly</h3>

  <!-- Upload Form -->
  <form id="uploadForm" enctype="multipart/form-data">
    <input type="file" id="file" name="file" accept=".csv" required><br>
    <button type="submit" id="analyzeBtn">ğŸš€ Analyze</button>
  </form>

  <!-- Preview & Mode -->
  <div id="previewContainer">
    <h4 id="previewTitle" style="display:none;">ğŸ“„ Preview / é è¦½</h4>
    <table id="previewTable"></table>
    <div id="modeLabel"></div>
    <div id="modeHint"></div>
  </div>

  <!-- Spinner -->
  <div class="spinner" id="spinner">â³ Analyzing / åˆ†æä¸­â€¦</div>

  <!-- ğŸ“‚ Reference Dataset Downloads -->
  <div style="margin-top:25px;">
    <h4>ğŸ“˜ Reference Datasets / ç¯„ä¾‹è³‡æ–™ä¸‹è¼‰</h4>
    <a href="/static/abstract_sample.csv" class="sample-btn" download>ğŸ§  Abstract Sample (1-column)</a>
    <a href="/static/coword_sample.csv" class="sample-btn" download>ğŸ¾ Co-Word Sample (multi-column)</a>
    <a href="/static/readme_dataset_information.txt" class="sample-btn" download>ğŸ“„ Readme Dataset Info</a>
  </div>

  <!-- ğŸ“Š Result Downloads (after analysis) -->
  <div id="resultDownloads">
    <h4>ğŸ“¤ Analysis Outputs / åˆ†æçµæœä¸‹è¼‰</h4>
    <a href="/static/output_vertices.csv" class="sample-btn" download>ğŸ”¹ Vertices (Top 20 Terms)</a>
    <a href="/static/output_relations.csv" class="sample-btn" download>ğŸ”¸ Relations (Edge Pairs)</a>
    <a href="/static/output_themes.csv" class="sample-btn" download>ğŸ§© Themes (1st Column Variable)</a>
  </div>

  <footer id="footer">
    Â© 2025 Smile Chien Â· TAAA Semanticâ€“Co-Word Analyzer v8.0
  </footer>
</div>

<script>
const form = document.getElementById('uploadForm');
const spinner = document.getElementById('spinner');
const fileInput = document.getElementById('file');
const previewTable = document.getElementById('previewTable');
const previewTitle = document.getElementById('previewTitle');
const modeLabel = document.getElementById('modeLabel');
const modeHint = document.getElementById('modeHint');
const analyzeBtn = document.getElementById('analyzeBtn');
const footer = document.getElementById('footer');
const resultDownloads = document.getElementById('resultDownloads');

let isZh = navigator.language.startsWith('zh');
if (isZh) {
  document.getElementById('title').textContent = "ğŸŒ TAAA èªç¾©â€“å…±è©åˆ†æå™¨";
  document.getElementById('subtitle').textContent = "è‡ªå‹•åˆ¤æ–·æ‘˜è¦æˆ–å…±è©è³‡æ–™ Â· æ”¯æ´å¤šèªç³»";
  analyzeBtn.textContent = "ğŸš€ é–‹å§‹åˆ†æ";
  spinner.textContent = "â³ åˆ†æä¸­â€¦è«‹ç¨å€™";
  footer.innerHTML = "Â© 2025 Smile Chien Â· TAAA èªç¾©â€“å…±è©åˆ†æå™¨ v8.0";
}

let currentMode = null;

// ğŸ“‹ CSV Preview + Auto Mode Detection
fileInput.addEventListener('change', (event) => {
  resultDownloads.style.display = 'none'; // hide old outputs
  const file = event.target.files[0];
  if (!file) {
    previewTable.style.display = 'none';
    previewTitle.style.display = 'none';
    modeLabel.style.display = 'none';
    modeHint.style.display = 'none';
    return;
  }

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = e.target.result;
    const rows = text.split(/\r?\n/).filter(r => r.trim().length > 0);
    const data = rows.slice(0, 6).map(r => r.split(/,|;|\t/));
    if (data.length === 0) return;

    let html = '<tr>' + data[0].map(h => `<th>${h}</th>`).join('') + '</tr>';
    for (let i = 1; i < Math.min(6, data.length); i++) {
      html += '<tr>' + data[i].map(c => `<td>${c}</td>`).join('') + '</tr>';
    }
    previewTable.innerHTML = html;
    previewTable.style.display = 'table';
    previewTitle.style.display = 'block';

    const colCount = data[0].length;
    let modeText, hintText;
    if (colCount <= 1) {
      modeText = isZh ? "ğŸ§  åµæ¸¬æ¨¡å¼ï¼šæ‘˜è¦æ¨¡å¼" : "ğŸ§  Detected: Abstract Mode";
      hintText = isZh ? "åµæ¸¬åˆ°å–®æ¬„æª”æ¡ˆ â†’ å°‡ä½¿ç”¨æ‘˜è¦åˆ†æ" : "Detected single-column file â†’ using abstract analysis";
      modeLabel.style.color = "#2a7";
      currentMode = "abstract";
    } else {
      modeText = isZh ? "ğŸ¾ åµæ¸¬æ¨¡å¼ï¼šå…±è©æ¨¡å¼" : "ğŸ¾ Detected: Co-Word Mode";
      hintText = isZh ? "åµæ¸¬åˆ°å¤šæ¬„æª”æ¡ˆ â†’ å°‡ä½¿ç”¨å…±è©åˆ†æ" : "Detected multi-column file â†’ using co-word analysis";
      modeLabel.style.color = "#07c";
      currentMode = "coword";
    }
    modeLabel.textContent = modeText;
    modeHint.textContent = hintText;
    modeLabel.style.display = 'block';
    modeHint.style.display = 'block';
    modeLabel.classList.remove('blink-green', 'blink-blue');
  };
  reader.onerror = () => alert('âŒ Unable to read file (check encoding)');
  reader.readAsText(file, 'utf-8');
});

// ğŸš€ Handle submission + animate + show result downloads
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  spinner.style.display = 'block';
  modeLabel.classList.remove('blink-green', 'blink-blue');
  if (currentMode === "abstract") {
    modeLabel.classList.add('blink-green');
  } else if (currentMode === "coword") {
    modeLabel.classList.add('blink-blue');
  }

  const data = new FormData();
  data.append('file', fileInput.files[0]);
  try {
    const response = await fetch('/analyze_csv', { method: 'POST', body: data });
    const html = await response.text();

    // Simulate showing result downloads (if generated files exist)
    resultDownloads.style.display = 'block';

    document.open();
    document.write(html);
    document.close();
  } catch {
    alert(isZh ? 'âŒ ä¸Šå‚³å¤±æ•—' : 'âŒ Upload failed');
    spinner.style.display = 'none';
    modeLabel.classList.remove('blink-green', 'blink-blue');
  }
});
</script>
</body>
</html>
