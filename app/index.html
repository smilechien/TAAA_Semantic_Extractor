<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TAAA Semantic + Cluster Visualizer (AAC)</title>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
body {font-family:"Segoe UI",sans-serif;margin:2em;}
.upload-box{border:2px dashed #aaa;padding:30px;text-align:center;width:60%;margin:auto;border-radius:12px;cursor:pointer;}
#graph{width:100%;height:80vh;margin-top:20px;}
button{padding:10px 20px;font-size:16px;margin:10px;}
</style>
</head>
<body>

<h2>üåê TAAA Semantic + Cluster Visualizer (AAC Metric)</h2>
<p>Upload a CSV containing <b>abstract</b> column. It extracts keywords, builds a top-20 network, computes AAC and draws cluster relations.</p>

<div class="upload-box" onclick="document.getElementById('file').click()">üì§ Click or Drag to Upload CSV</div>
<input id="file" type="file" style="display:none" />
<br><button onclick="runVisualization()">Run Visualization</button>

<div id="graph"></div>
<div id="downloads" style="margin-top:10px;text-align:center;"></div>

<script>
async function runVisualization(){
  const f=document.getElementById('file');
  if(!f.files.length) return alert("Please choose a CSV file.");
  const fd=new FormData(); fd.append("file",f.files[0]);
  const res=await fetch("/visualize",{method:"POST",body:fd});
  const data=await res.json();
  if(data.error) return alert(data.error);

  const N=data.nodes, E=data.edges, meanX=data.meanX, meanY=data.meanY, aac=data.aac;

  // Edge trace (width ‚àù weight)
  const edgeTrace={
    x:E.flatMap(e=>[N.find(n=>n.id===e.source).x,N.find(n=>n.id===e.target).x,null]),
    y:E.flatMap(e=>[N.find(n=>n.id===e.source).y,N.find(n=>n.id===e.target).y,null]),
    mode:'lines',
    line:{width:E.map(e=>1+2*e.weight),color:'#bbb'},
    hoverinfo:'none'
  };

  // Node trace (color = cluster, size = frequency)
  const nodeTrace={
    x:N.map(n=>n.x), y:N.map(n=>n.y),
    text:N.map(n=>`${n.id}<br>Cluster ${n.cluster}<br>Freq: ${n.freq}`),
    mode:'markers+text', textposition:'top center',
    marker:{size:N.map(n=>8+n.freq),color:N.map(n=>n.cluster),colorscale:'Viridis',showscale:true},
    hoverinfo:'text'
  };

  const meanXline={type:'line',x0:meanX,x1:meanX,y0:-1,y1:1,line:{color:'red',dash:'dot'}};
  const meanYline={type:'line',x0:-1,x1:1,y0:meanY,y1:meanY,line:{color:'red',dash:'dot'}};

  Plotly.newPlot('graph',[edgeTrace,nodeTrace],{
    title:`Top-20 Co-Word Clusters  |  AAC = ${aac}`,
    shapes:[meanXline,meanYline],
    xaxis:{showgrid:false,zeroline:false,visible:false},
    yaxis:{showgrid:false,zeroline:false,visible:false}
  });

  // Download links
  const d=document.getElementById('downloads');
  d.innerHTML=`<a href="${data.download.keywords}" download="taaa_keywords.csv">‚¨áÔ∏è Download Keywords CSV</a> &nbsp;&nbsp;
               <a href="${data.download.clusters}" download="taaa_clusters.csv">‚¨áÔ∏è Download Clusters CSV</a>`;
}
</script>
</body>
</html>
